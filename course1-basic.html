<!DOCTYPE html>
<html>
<head>
  <title>Course 1 Basic</title>
</head>
<body>
  <h1>Preview of Course 1</h1>
  <button id="buyBtn">Buy Now (Demo)</button>

  <!-- Firebase Setup and Utilities -->
  <script type="module">
    // Firebase imports
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js";
    import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";

    // Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyBvqzYTaepJn-WvWMPSZJe26Ydkw-7MXLE",
      authDomain: "syncskilll.firebaseapp.com",
      projectId: "syncskilll",
      storageBucket: "syncskilll.appspot.com",
      messagingSenderId: "203322315096",
      appId: "1:203322315096:web:958fc7d94806ef9a98552d",
      measurementId: "G-JWWWM2ZQSK"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // Handle user auth and course access
    onAuthStateChanged(auth, async (user) => {
      if (user) {
        const uid = user.uid;
        const course = "course1";
        const ref = doc(db, "userPurchases", uid);
        const snap = await getDoc(ref);
        const purchasedCourses = snap.exists() ? snap.data().purchasedCourses || [] : [];

        // ✅ Redirect if already purchased
        if (purchasedCourses.includes(course)) {
          window.location.href = `${course}-premium.html`;
          return;
        }

        // ❌ If not purchased, handle buy button
        document.getElementById("buyBtn").onclick = () => {
          window.location.href = `fake-payment.html?course=${course}&uid=${uid}`;
        };
      } else {
        alert("Please login first.");
        window.location.href = "login.html";
      }
    });

    // OPTIONAL: Auto logout after inactivity (1 hour)
    const logout = async () => {
      try {
        await signOut(auth);
        sessionStorage.clear();
        localStorage.clear();
        window.location.href = "/index.html";
      } catch (error) {
        console.error("Logout error:", error);
        alert("Error during logout. Please try again.");
      }
    };

    let inactivityTimer;
    const resetSessionTimer = () => {
      clearTimeout(inactivityTimer);
      inactivityTimer = setTimeout(() => logout(), 3600000); // 1 hour
    };
    ['mousemove', 'keydown', 'scroll', 'touchstart'].forEach(event => {
      window.addEventListener(event, resetSessionTimer);
    });
    resetSessionTimer();

    // Prevent cached page on back button
    window.addEventListener('pageshow', (event) => {
      if (event.persisted || window.performance?.navigation?.type === 2) {
        if (!auth.currentUser) window.location.href = "login.html";
      }
    });
  </script>
</body>
</html>
